<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turerez - MCP Powered Internshala Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .demo-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .main-content {
            padding: 40px;
        }

        .search-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .search-container {
            position: relative;
            max-width: 700px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 20px 25px;
            font-size: 1.1rem;
            border: 2px solid #e1e5e9;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .search-input:focus {
            border-color: #2196F3;
            box-shadow: 0 5px 25px rgba(33,150,243,0.2);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 5px 15px rgba(33,150,243,0.3);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 10px 20px;
            border: 2px solid #2196F3;
            background: white;
            color: #2196F3;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .control-btn:hover {
            background: #2196F3;
            color: white;
        }

        .control-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
            color: white;
        }

        .examples {
            margin-top: 20px;
        }

        .example-chips {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .chip {
            background: #f5f7fa;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e1e5e9;
        }

        .chip:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateY(-2px);
        }

        .processing {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .workflow-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: white;
        }

        .step1 { background: #4CAF50; }
        .step2 { background: #FF9800; }
        .step3 { background: #9C27B0; }
        .step4 { background: #F44336; }
        .step5 { background: #2196F3; }

        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table-header {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .data-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 2fr;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .data-row:hover {
            background: #f8f9fa;
        }

        .data-cell {
            padding: 5px 10px;
        }

        .company-name {
            font-weight: 600;
            color: #2196F3;
        }

        .stipend {
            font-weight: 600;
            color: #4CAF50;
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .download-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }

        .tech-stack {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
        }

        .tech-icons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tech-item {
            text-align: center;
        }

        .tech-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .feature-toggle {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">System Ready</span>
            </div>
            <h1>üöÄ Turerez Web Interface</h1>
            <p>Natural Language Powered Internshala Automation with MCP Integration</p>
            <span class="demo-badge">üéì Production Ready System</span>
        </div>

        <div class="main-content">
            <!-- System Controls -->
            <div class="feature-toggle">
                <h3 style="margin-bottom: 15px;">üîß System Controls</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>Browser Automation:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="browserToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>AI Features:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="aiToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>Real-time Mode:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="realtimeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Alert Area -->
            <div id="alertArea"></div>

            <!-- Search Section -->
            <div class="search-section">
                <h2 style="margin-bottom: 20px; color: #333;">Enter Your Natural Language Command</h2>
                <div class="search-container">
                    <input type="text" 
                           class="search-input" 
                           id="commandInput"
                           placeholder="e.g., Show marketing internships from startups with stipend above 5000"
                           autocomplete="off">
                    <button class="search-btn" id="searchBtn" onclick="processCommand()">
                        üîç Process
                    </button>
                </div>
                
                <div class="controls">
                    <button class="control-btn" onclick="loadMCPTools()">üìã Available Tools</button>
                    <button class="control-btn" onclick="checkSystemStatus()">üîç System Status</button>
                    <button class="control-btn" onclick="exportLastResults()">üíæ Export Data</button>
                </div>
                
                <div class="examples">
                    <p style="color: #666; margin-bottom: 10px;">Try these example commands:</p>
                    <div class="example-chips">
                        <div class="chip" onclick="fillExample('Show graphic design internships posted in last 7 days')">Recent Design Jobs</div>
                        <div class="chip" onclick="fillExample('Find marketing internships from startups with stipend above 10000')">High-Stipend Marketing</div>
                        <div class="chip" onclick="fillExample('Download chat messages from last 5 days')">Recent Chat Messages</div>
                        <div class="chip" onclick="fillExample('Show remote tech internships for students')">Remote Tech Jobs</div>
                        <div class="chip" onclick="fillExample('Analyze market trends for content writing')">Market Analysis</div>
                        <div class="chip" onclick="fillExample('Get recommendations for my profile')">AI Recommendations</div>
                    </div>
                </div>
            </div>

            <div class="processing" id="processing">
                <div class="spinner"></div>
                <h3 id="processingTitle">Processing your request...</h3>
                <p id="processingDetails">MCP is translating your command and executing automation</p>
            </div>

            <div class="results" id="results">
                <div class="workflow-display">
                    <h3 style="margin-bottom: 20px; text-align: center;">üîÑ MCP Workflow Execution</h3>
                    <div id="workflowSteps">
                        <!-- Workflow steps will be populated here -->
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        üìä Results - <span id="resultCount">0</span> Items Found
                    </div>
                    <div class="table-content">
                        <div class="data-row" id="tableHeader" style="font-weight: bold; background: #f5f5f5;">
                            <!-- Headers will be set dynamically -->
                        </div>
                        <div id="dataRows">
                            <!-- Data will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="download-section">
                    <h3 style="margin-bottom: 15px;">üíæ Export Options</h3>
                    <button class="download-btn" onclick="downloadData('csv')">üìÑ Download CSV</button>
                    <button class="download-btn" onclick="downloadData('json')">üìã Download JSON</button>
                    <button class="download-btn" onclick="downloadData('excel')">üìä Download Excel</button>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9rem;" id="exportNote">
                        Real-time data export from your Turerez automation system
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.origin;
        
        // Global state
        let currentResults = [];
        let currentQuery = '';
        let systemStatus = {};

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            loadMCPTools();
        });

        // System Status Management
        async function checkSystemStatus() {
            try {
                showAlert('Checking system status...', 'info');
                
                const response = await fetch(`${API_BASE}/api/status`);
                const status = await response.json();
                
                systemStatus = status;
                updateStatusIndicator(status);
                updateToggles(status);
                
                showAlert('System status updated successfully', 'success');
                setTimeout(() => hideAlert(), 2000);
                
            } catch (error) {
                console.error('Status check failed:', error);
                showAlert('Failed to check system status', 'error');
                updateStatusIndicator({ error: true });
            }
        }

        function updateStatusIndicator(status) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (status.error) {
                statusDot.style.background = '#F44336';
                statusText.textContent = 'System Error';
            } else if (status.mcp_server === 'ready' && status.browser === 'connected') {
                statusDot.style.background = '#4CAF50';
                statusText.textContent = 'Fully Connected';
            } else if (status.mcp_server === 'ready') {
                statusDot.style.background = '#FF9800';
                statusText.textContent = 'MCP Ready';
            } else {
                statusDot.style.background = '#F44336';
                statusText.textContent = 'System Error';
            }
        }

        function updateToggles(status) {
            document.getElementById('browserToggle').checked = status.browser === 'connected';
            document.getElementById('aiToggle').checked = status.ai_features === true;
            document.getElementById('realtimeToggle').checked = false; // Default off
        }

        // Browser Control
        document.getElementById('browserToggle').addEventListener('change', async function(e) {
            const action = e.target.checked ? 'connect' : 'disconnect';
            
            try {
                showAlert(`${action === 'connect' ? 'Connecting' : 'Disconnecting'} browser...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/browser-control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, headless: true })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                } else {
                    showAlert('Browser control failed', 'error');
                    e.target.checked = !e.target.checked; // Revert toggle
                }
                
            } catch (error) {
                console.error('Browser control error:', error);
                showAlert('Browser control failed', 'error');
                e.target.checked = !e.target.checked; // Revert toggle
            }
        });

        // MCP Tools Loading
        async function loadMCPTools() {
            try {
                const response = await fetch(`${API_BASE}/api/mcp-tools`);
                const data = await response.json();
                
                const toolCount = data.tools ? data.tools.length : 0;
                const aiAvailable = data.ai_available !== undefined ? data.ai_available : false;
                
                showAlert(`Loaded ${toolCount} MCP tools. AI Features: ${aiAvailable ? 'Available' : 'Not Available'}`, 'info');
                
                console.log('Available MCP Tools:', data.tools || []);
                setTimeout(() => hideAlert(), 3000);
                
            } catch (error) {
                console.error('Failed to load MCP tools:', error);
                showAlert('Failed to load MCP tools', 'error');
            }
        }

        // Main Query Processing
        async function processCommand() {
            const input = document.getElementById('commandInput').value.trim();
            if (!input) {
                showAlert('Please enter a command', 'error');
                return;
            }

            currentQuery = input;
            
            // Show processing state
            document.querySelector('.search-section').style.display = 'none';
            document.getElementById('processing').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            document.getElementById('searchBtn').disabled = true;

            try {
                // Send query to backend
                const response = await fetch(`${API_BASE}/api/process-query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: input,
                        user_preferences: {
                            realtime_mode: document.getElementById('realtimeToggle').checked
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    currentResults = result.data;
                    displayResults(result);
                } else {
                    throw new Error('Query processing failed');
                }
                
            } catch (error) {
                console.error('Query processing error:', error);
                showAlert(`Query processing failed: ${error.message}`, 'error');
                
                // Reset UI
                document.querySelector('.search-section').style.display = 'block';
                document.getElementById('processing').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // Results Display
        function displayResults(result) {
            // Hide processing, show results
            document.getElementById('processing').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // Update result count
            document.getElementById('resultCount').textContent = result.data.length;

            // Display workflow steps
            displayWorkflowSteps(result.processing_steps);

            // Display data based on query type
            if (result.metadata.query_type === 'chat_extraction') {
                displayChatResults(result.data);
            } else if (result.metadata.query_type === 'market_analysis') {
                displayAnalysisResults(result.data);
            } else {
                displayInternshipResults(result.data);
            }

            // Update export note
            const isRealData = !result.metadata.note || !result.metadata.note.includes('Demo');
            document.getElementById('exportNote').textContent = isRealData 
                ? 'Real-time data export from your Turerez automation system'
                : 'Demo data export for development and testing purposes';

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
            // Re-enable search
            document.getElementById('searchBtn').disabled = false;
        }

        function displayWorkflowSteps(steps) {
            const workflowContainer = document.getElementById('workflowSteps');
            workflowContainer.innerHTML = '';

            steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'workflow-step';
                stepDiv.innerHTML = `
                    <div class="step-icon step${index + 1}">${index + 1}</div>
                    <div>
                        <strong>${step.step}</strong><br>
                        <span>${step.status}</span>
                    </div>
                `;
                workflowContainer.appendChild(stepDiv);
            });
        }

        function displayInternshipResults(data) {
            // Set headers for internship data
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = `
                <div class="data-cell">Company & Role</div>
                <div class="data-cell">Location</div>
                <div class="data-cell">Stipend</div>
                <div class="data-cell">Duration</div>
                <div class="data-cell">Posted Date</div>
            `;

            const dataRows = document.getElementById('dataRows');
            dataRows.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('div');
                row.className = 'data-row';
                row.innerHTML = `
                    <div class="data-cell">
                        <div class="company-name">${item.company || 'N/A'}</div>
                        <div style="color: #666; font-size: 0.9rem;">${item.role || item.title || 'N/A'}</div>
                    </div>
                    <div class="data-cell">${item.location || 'N/A'}</div>
                    <div class="data-cell stipend">${item.stipend || 'N/A'}</div>
                    <div class="data-cell">${item.duration || 'N/A'}</div>
                    <div class="data-cell">${item.posted || item.date || 'N/A'}</div>
                `;
                dataRows.appendChild(row);
            });
        }

        function displayChatResults(data) {
            // Set headers for chat data
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = `
                <div class="data-cell">Sender</div>
                <div class="data-cell" style="grid-column: span 3;">Message</div>
                <div class="data-cell">Time</div>
            `;

            const dataRows = document.getElementById('dataRows');
            dataRows.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('div');
                row.className = 'data-row';
                row.innerHTML = `
                    <div class="data-cell company-name">${item.sender || item.from || 'Unknown'}</div>
                    <div class="data-cell" style="grid-column: span 3;">${item.message || item.content || 'N/A'}</div>
                    <div class="data-cell">${item.timestamp || item.time || 'N/A'}</div>
                `;
                dataRows.appendChild(row);
            });
        }

        function displayAnalysisResults(data) {
            // Set headers for analysis data
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = `
                <div class="data-cell">Metric</div>
                <div class="data-cell" style="grid-column: span 2;">Value</div>
                <div class="data-cell" style="grid-column: span 2;">Trend</div>
            `;

            const dataRows = document.getElementById('dataRows');
            dataRows.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('div');
                row.className = 'data-row';
                row.innerHTML = `
                    <div class="data-cell company-name">${item.metric || item.name || 'N/A'}</div>
                    <div class="data-cell" style="grid-column: span 2;">${item.value || item.result || 'N/A'}</div>
                    <div class="data-cell" style="grid-column: span 2;">${item.trend || item.change || 'N/A'}</div>
                `;
                dataRows.appendChild(row);
            });
        }

        // Data Export Functions
        async function downloadData(format) {
            if (currentResults.length === 0) {
                showAlert('No data to download', 'error');
                return;
            }

            try {
                showAlert(`Preparing ${format.toUpperCase()} export...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        format: format,
                        analytics_level: 'standard',
                        include_charts: false
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // For demo purposes, generate client-side download
                    generateClientSideDownload(format);
                    showAlert(`${format.toUpperCase()} export completed`, 'success');
                } else {
                    // Fallback to client-side generation
                    generateClientSideDownload(format);
                    showAlert(`${format.toUpperCase()} export generated (client-side)`, 'info');
                }
                
            } catch (error) {
                console.error('Export error:', error);
                // Fallback to client-side generation
                generateClientSideDownload(format);
                showAlert(`${format.toUpperCase()} export generated (fallback mode)`, 'info');
            }
        }

        function generateClientSideDownload(format) {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `turerez_export_${timestamp}`;
            
            if (format === 'csv') {
                downloadCSV(filename);
            } else if (format === 'json') {
                downloadJSON(filename);
            } else {
                // For Excel, download as CSV with Excel extension
                downloadCSV(filename, 'excel');
            }
        }

        function downloadCSV(filename, type = 'csv') {
            let csvContent = '';
            const extension = type === 'excel' ? 'xlsx' : 'csv';
            
            if (currentResults.length > 0) {
                const firstItem = currentResults[0];
                
                if (firstItem.company) {
                    // Internship data
                    csvContent = 'Company,Role,Location,Stipend,Duration,Posted\n';
                    currentResults.forEach(item => {
                        csvContent += `"${item.company || ''}","${item.role || ''}","${item.location || ''}","${item.stipend || ''}","${item.duration || ''}","${item.posted || ''}"\n`;
                    });
                } else if (firstItem.sender || firstItem.from) {
                    // Chat data
                    csvContent = 'Sender,Message,Timestamp\n';
                    currentResults.forEach(item => {
                        csvContent += `"${item.sender || item.from || ''}","${item.message || item.content || ''}","${item.timestamp || item.time || ''}"\n`;
                    });
                } else if (firstItem.metric) {
                    // Analysis data
                    csvContent = 'Metric,Value,Trend\n';
                    currentResults.forEach(item => {
                        csvContent += `"${item.metric || ''}","${item.value || ''}","${item.trend || ''}"\n`;
                    });
                }
            }

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.${extension}`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function downloadJSON(filename) {
            const jsonData = {
                query: currentQuery,
                timestamp: new Date().toISOString(),
                results_count: currentResults.length,
                data: currentResults,
                system_info: {
                    source: "Turerez MCP Automation",
                    version: "1.0.0",
                    export_type: "json"
                }
            };

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Export last results function
        async function exportLastResults() {
            if (currentResults.length === 0) {
                showAlert('No recent results to export. Run a query first.', 'error');
                return;
            }
            
            // Show export options
            const format = prompt('Choose export format:\n1. CSV\n2. JSON\n3. Excel\n\nEnter 1, 2, or 3:', '1');
            const formatMap = { '1': 'csv', '2': 'json', '3': 'excel' };
            
            if (formatMap[format]) {
                downloadData(formatMap[format]);
            } else {
                showAlert('Invalid format selected', 'error');
            }
        }

        // Utility Functions
        function fillExample(text) {
            document.getElementById('commandInput').value = text;
            document.getElementById('commandInput').focus();
        }

        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `<div class="alert ${type}" style="display: block;">${message}</div>`;
        }

        function hideAlert() {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = '';
        }

        // Keyboard shortcuts
        document.getElementById('commandInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processCommand();
            }
        });

        // Auto-focus on input
        document.getElementById('commandInput').focus();

        // Periodic status check
        setInterval(checkSystemStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>
